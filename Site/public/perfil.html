<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/2eecc47c4e.js" crossorigin="anonymous"></script>
    <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./assets/js/funcoes.js"></script>
    <script src="./assets/ckEditor/build/ckeditor.js"></script>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <title>Perfil</title>
</head>

<body onload="verifyAuth()">
    <div id="perfil-menu">
        <div class="perfil-menu-container">

            <ul class="nav-bar">
                <li class="nav-bar-item">
                    <a href="./index.html">
                        <i class="fa-solid fa-house menu-icon"></i>
                        <span class="nav-bar-name" id="home">Início</span>
                    </a>
                </li>
                <li class="nav-bar-item">
                    <a href="./mapas.html">
                        <i class="fa fa-map svelte-1uw9g1y menu-icon"></i>
                        <span class="nav-bar-name" id="mapas">Mapas</span>
                    </a>
                </li>
                <li class="nav-bar-item">
                    <a href="./ranking.html">
                        <i class="fa fa-medal svelte-1uw9g1y menu-icon"></i>
                        <span class="nav-bar-name" id="ranking">Ranking</span>
                    </a>
                </li>
                
                <li class="nav-bar-item">
                    <a href="./pesquisar.html">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <span class="nav-bar-name" id="pesquisar">Pesquisar</span>
                    </a>
                </li>
                <li class="nav-bar-item">
                    <a href="./cadastro.html">
                        <i class="fa fa-user svelte-1uw9g1y menu-icon"></i>
                        <span class="nav-bar-name" id="cadastro">Cadastro</span>
                    </a>
                </li>
                <li class="nav-bar-item">
                    <a href="./login.html">
                        <i class="fa fa-user svelte-1uw9g1y menu-icon"></i>
                        <span class="nav-bar-name" id="login">Login</span>
                    </a>
                </li>

            </ul>
        </div>

        <div class="user-container">
        </div>

    </div>

    <div class="banner">
        <div class="img-container">
            <img src="./assets/img/bsbg.jpg" class="background-image">
            <i class="fa-solid fa-pen" onclick="editImage('background')"></i>
            <input type="file" id="arquivo-background" accept="image/png, image/gif, image/jpeg"
                style="display: none; cursor: pointer;" onchange="sendImage(this)">
        </div>
        <div class="perfil-banner">
            <div class="pattern-dots-regular">
                <div class="perfil-container">
                    <div class="player-header-container">
                        <div style="position: relative;">
                            <img class="perfil-img" id="perfil-img" src="./assets/img/oculus.png"
                                onerror="this.src='./assets/img/oculus.png'"> <!-- Mudar Imagem para local -->
                            <i class="fa-solid fa-pen" onclick="editImage('')"></i>
                            <form action="">
                                <input type="file" id="arquivo-perfil" accept="image/png, image/gif, image/jpeg"
                                    style="display: none; cursor: pointer;" onchange="sendImage(this)">
                            </form>
                        </div>
                        <div class="player-name-container">
                            <div>
                                <span class="player-name" id="player-name"></span>
                                <i class="fa-solid fa-pen" onclick="editName()"></i>
                            </div>
                            <div class="flag-country">
                            </div>
                        </div>
                        <div class="player-position-info">

                            <div class="global-container">
                                <span>Posição Global:</span>
                                <span id="posicaoGlobal">#0</span>
                            </div>
                            <div class="nacional-container">
                                <span>Posição Nacional:</span>
                                <span id="posicaoNacional">#0</span>
                            </div>
                        </div>
                        <div class="hide-background-container">
                            <div class="hide-background" onclick="hideBackground()">
                                <i id='hide-bk' class="fa-solid fa-chevron-up"></i>
                            </div>
                        </div>
                    </div>
                    <div class="position-info-chart-container">
                        <div class="position-chart">
                            <canvas id="myChart" width="" height="90"></canvas>
                        </div>
                        <div class="round-border"></div>

                        <div class="player-info">
                            <div class="player-info-label">
                                <span>Vr Utilizado:</span>
                                <span>Precisão:</span>
                                <span>Pontuação Total:</span>
                                <span>Replays Assistidos por Outros:</span>
                                <span>Total de Pontos de Performace:</span>
                            </div> <!-- Adicionar muito espaço entre eles, tipo o do osu -->
                            <div class="player-info-label">

                                <span id="vrUtilizado">Desconhecido</span>
                                <span id="precisaoMedia">0.00%</span>
                                <span id="pontuacaoTotal">0</span>
                                <span id="replaysAssistidos">0</span>
                                <span id="ppTotal">0pp</span>
                            </div>

                            <!-- <i class="fa-brands fa-youtube"></i> -->
                            <!-- <i class="fa-brands fa-twitch"></i> -->
                            <!-- <i class="fa-brands fa-twitter"></i> -->
                        </div>
                    </div>
                    <ul class="labels-player">
                        <li class="player-label">
                            <a href="#eu_section" class="player-label-name" onclick="changeLabelColor(this)">Sobre mim</a>
                        </li>
                        <li class="player-label">
                            <a href="#Classificacao_section" class="player-label-name"
                                onclick="changeLabelColor(this)">Mapas Jogados</a>
                        </li>
                        <li class="player-label">
                            <a href="#mapas-favoritos-section" class="player-label-name"
                                onclick="changeLabelColor(this)">Mapas Favoritos</a>
                        </li>
                    </ul>

                    <section class="player-label-container" id="eu_section"
                        style="display: flex; align-items: center; flex-direction: column;">
                        <div style="width: 95%;">
                            <div class="player-label-title-container">
                                <h3 class="player-label-title">Sobre mim</h3>
                            </div>
                        </div>
                        <div class="editor-box-container">
                            <div style="width: 97%; height: fit-content;">
                                <div id="editor-box"></div>
                                <div id="editor-buttons" style="width: 100%"></div>
                            </div>
                        </div>
                    </section>

                    <section class="player-label-container" id="Classificacao_section">
                        <div style="width: 95%; position: relative; display: flex;">
                            <div class="player-label-title-container">
                                <h3 class="player-label-title">Mapas Jogados</h3>
                            </div>
                            <div class="player-select-type-score">
                                <ul>
                                    <li class="type-scores">Melhores</li>
                                    <li class="type-scores">Recentes</li>
                                </ul>
                            </div>
                        </div>

                        <ul id="scores-player-list">
                        </ul>
                        <div class="pages-list">
                            <ul class="pages" style="color: white;">
                            </ul>
                        </div>
                    </section>

                    <section class="player-label-container" id="mapas-favoritos-section">
                        <div style="width: 95%; position: relative; display: flex;">
                            <div class="player-label-title-container">
                                <h3 class="player-label-title">Mapas Favoritos</h3>
                            </div>
                        </div>

                        <ul id="scores-favorite-player-list">
                        </ul>
                        <div class="pages-list">
                            <ul class="pages" style="color: white;">
                            </ul>
                        </div>
                    </section>
                </div>
            </div>

        </div>

    </div>
</body>

<script>

    function startEditor() {
        ClassicEditor.create(document.getElementById('editor-box'), {
            licenseKey: '',
        })
            .then(editor => {
                window.editor = editor;
                /* editor.model.document.on('change:data', () => {
                    console.log(editor.getData());
                }); */
                editDescription();
            })
            .catch(error => {
                console.error('Oops, something went wrong!');
                console.error('Please, report the following error on https://github.com/ckeditor/ckeditor5/issues with the build id and the error stack trace:');
                console.warn('Build id: pkg0toth4spz-jl0u3y5i3cfk');
                console.error(error);
            });
    }

    function startDescription() {
        document.getElementById('editor-box')
    }
</script> <!-- Editor -->

<script>

    var pagina;
    var paginaFavorito = 1;

    function playerPositionChart(historico) {
        let labels = [];
        let positionsData = [];
        if (historico == undefined) historico = [];
        historico.forEach(dataHistorico => {
            for (let i = 0; i < 25; i++) {
                let date = new Date().getDate()
                let month = ("0" + (new Date().getMonth() + 1)).slice(-2);
                let year = new Date().getFullYear();

                let today = subDate(`${year}-${month}-${date}`, i);

                if (today == dataHistorico.diaRank.split('T')[0]) {
                    let msg;
                    if (i == 0) msg = 'Hoje';
                    else if (i == 1) msg = 'Ontem';
                    else msg = `${i} Dias atrás`
                    labels.push(msg);
                    positionsData.push(dataHistorico.rankGlobal);
                }
            }
        });

        positionsData = positionsData.map((numString) => {
            let num = parseInt(numString);
            return num;
        });

        const data = {
            labels: labels,
            datasets: [{
                label: 'Rank',
                backgroundColor: 'rgb(58, 82, 125)',
                borderColor: 'rgb(58, 82, 125)',
                data: positionsData,
                tension: 0.4,
                pointRadius: 1.2,
                hoverPointRadius: 1.2
            }]
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                scales: {
                    yAxis: {
                        reverse: true,
                        ticks: {
                            min: Math.min(...positionsData),
                            max: Math.max(...positionsData),
                            stepSize: 50,
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        };
        const myChart = new Chart(
            document.getElementById('myChart'),
            config
        );
    }

    setPlayerInformations();

    function getURLParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const idJogador = urlParams.get('id');
        wpagina = parseInt(urlParams.get('page'));

        if (idJogador == null) {
            window.location = `./ranking.html`;
        }
        if (sessionStorage.IDJOGADOR == idJogador) {
            let token = sessionStorage.TOKENJOGADOR;
            if (token != undefined) {
                letCustomize(idJogador, token);
            }
        }
        if (isNaN(pagina)) pagina = 1;

        return [idJogador, pagina];
    }

    async function getCountryFlags() {
        let response = await fetch(`/jogador/countryFlag`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        })

        console.log('Resposta: ', response);

        if (response.ok) {
            console.log('Informações dos países obtidas.');
            let json = await response.json();
            return json;
        }
    }

    async function setPlayerInformations() {
        let [idJogador] = getURLParams();
        let countryFlags = await getCountryFlags();
        getPlayerInfo(idJogador, countryFlags);

        carregarDescricao(idJogador);
        document.getElementsByClassName('type-scores')[0].classList.add('selected');
        getPlayerScores(idJogador, pagina)
        getPlayerScoresFavorite(idJogador);
    }

    function getPlayerInfo(idJogador, countryFlags, pagina) {
        fetch(`/jogador/obterInfo/${idJogador}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    console.log('Informação do jogador obtido');

                    setPlayerInfo(idJogador, json, countryFlags);
                    playerPositionChart(json.historico);
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao carregar o perfil!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                    willClose: () => {
                        window.location = `./ranking.html`;
                    }
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })
    }

    function setPlayerInfo(idJogador, json, countryFlags) {
        let player = json;
        let playerInfo = player.infoJogador;
        document.getElementById('perfil-img').src = `./jogador/getImage/${idJogador}`;
        document.getElementById('player-name').innerHTML = playerInfo.nome.trim();

        let countryName = (countryFlags.filter(country => { return playerInfo.pais == country.code }))[0];

        setPlayerCountry(document.getElementsByClassName('flag-country')[0], countryName.name, countryName.code, countryFlags);

        document.getElementById('posicaoGlobal').innerHTML = `#${player.rankGlobal}`;
        document.getElementById('posicaoNacional').innerHTML = `#${player.rankNacional}`;


        if (playerInfo.vrUtilizado == null) playerInfo.vrUtilizado = 'Desconhecido';
        document.getElementById('vrUtilizado').innerHTML = `${playerInfo.vrUtilizado}`;
        if (playerInfo.precisaoMedia == null) playerInfo.precisaoMedia = 0;
        if (playerInfo.pontuacaoTotal == null) playerInfo.pontuacaoTotal = 0;
        if (playerInfo.ppTotal == null) playerInfo.ppTotal = 0;
        document.getElementById('precisaoMedia').innerHTML = `${playerInfo.precisaoMedia}%`;
        document.getElementById('pontuacaoTotal').innerHTML = `${playerInfo.pontuacaoTotal}`;
        document.getElementById('replaysAssistidos').innerHTML = `${playerInfo.replaysAssistidos}`;
        document.getElementById('ppTotal').innerHTML = `${playerInfo.ppTotal}pp`;


    }

    function changeLabelColor(thisElement) {
        let documentLabel = document.getElementsByClassName('player-label-name');

        for (let i = 0; i < documentLabel.length; i++) {
            let label = documentLabel[i];
            label.classList.remove('chosen');
        }
        thisElement.classList.add('chosen');
    }

    function hideBackground() {
        let container = document.getElementsByClassName('img-container');
        let arrow = document.getElementById('hide-bk');
        let editImageElement = document.getElementsByClassName('fa-pen');

        if (arrow.classList[1] === 'fa-chevron-up') {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
            container[0].style.height = '0px';
            editImageElement[0].style.display = 'none';
        } else {
            arrow.classList.remove('fa-chevron-down');
            arrow.classList.add('fa-chevron-up');
            container[0].style.height = '250px';
            if (editImageElement[0].style.display == 'none') return;
            editImageElement[0].style.display = 'block';

        }
    }

    function enviarDescricao() {
        let data = window.editor.getData();
        let idJogador = sessionStorage.IDJOGADOR;

        fetch(`/jogador/setarDescricao`, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idJogadorServer: idJogador,
                dadosDescricaoServer: data,
            })
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    window.editor.data = json.descricao;
                    document.getElementById('editor-buttons').innerHTML = '';
                    document.getElementById('editor-box').innerHTML = window.editor.data;
                    document.getElementById('editor-box').style.display = 'block';
                    document.getElementsByClassName('ck ck-reset ck-editor ck-rounded-corners')[0].remove();

                    document.getElementById('editor-buttons').appendChild(editDescriptionButton());
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao obter a permissão para editar a descrição!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })
    }

    function carregarDescricao(idJogador) {

        fetch(`/jogador/obterDescricao/${idJogador}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    console.log('Descrição do jogador obtida.');
                    document.getElementById('editor-box').innerHTML = json.descricao;
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao obter a permissão para editar a descrição!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })
    }

    function cancelarDescricao() {
        window.location.reload();
    }

    function editDescription() {
        let cancelButton = createCancelButton();
        let feitoButton = createFeitoButton();
        document.getElementById('editor-buttons').appendChild(cancelButton);
        document.getElementById('editor-buttons').appendChild(feitoButton);
    }

    function letCustomize(idJogador, token) {

        fetch(`/jogador/verificarEdicao/${idJogador}&${token}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    if (json.permission == true) {
                        console.log('Permissão para editar concedida.')
                        document.getElementById('editor-buttons').appendChild(editDescriptionButton());
                        let editImageElement = document.getElementsByClassName('fa-pen');
                        /* for (let i = 0; i < editImageElement.length; i++) {
                        } */
                        editImageElement[2].style.display = 'block';
                    }
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao obter a permissão para editar a descrição!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })

    }

    function createCancelButton() {
        let cancelButton = document.createElement('button');
        cancelButton.onclick = () => cancelarDescricao();
        cancelButton.classList.add('button-login');
        cancelButton.id = 'cancel-description';
        cancelButton.style.width = '100px';
        cancelButton.style.height = '40px';
        cancelButton.style.fontSize = '15px';
        cancelButton.style.float = 'right';
        cancelButton.style.backgroundColor = '#ca3434';
        cancelButton.style.margin = ' 10px 20px 0px 0px';
        cancelButton.innerHTML = 'Cancelar';
        return cancelButton;
    }

    function createFeitoButton() {
        let feitoButton = document.createElement('button');
        feitoButton.onclick = () => enviarDescricao();
        feitoButton.classList.add('button-login');
        feitoButton.id = 'commit-description';
        feitoButton.style.width = '100px';
        feitoButton.style.height = '40px';
        feitoButton.style.fontSize = '15px';
        feitoButton.style.backgroundColor = '#81ca34';
        feitoButton.style.float = 'right';
        feitoButton.style.margin = ' 10px 20px 0px 0px';
        feitoButton.innerHTML = 'Feito';
        return feitoButton;
    }

    function editDescriptionButton() {
        let descriptionButton = document.createElement('button');
        descriptionButton.onclick = () => {
            document.getElementById('edit-description').remove();
            startEditor();
        }
        descriptionButton.classList.add('button-login');
        descriptionButton.id = 'edit-description';
        descriptionButton.style.width = '100px';
        descriptionButton.style.height = '40px';
        descriptionButton.style.fontSize = '15px';
        descriptionButton.style.float = 'right';
        descriptionButton.style.margin = ' 10px 20px 0px 0px';
        descriptionButton.innerHTML = 'Editar';
        return descriptionButton;
    }

    function getPlayerScores(idJogador, pagina) {
        let typesScores = document.getElementsByClassName('type-scores');
        for (let i = 0; i < typesScores.length; i++) {
            if (typesScores[i].classList.contains('selected')) {
                type = typesScores[i].innerHTML.toLocaleLowerCase() == 'melhores' ? 'top' : 'recent'
                typesScores[i].onclick = () => { };
            } else {
                typesScores[i].onclick = () => { changeScores(typesScores[i], idJogador, pagina) };
            }
        }

        fetch(`/score/listarScoresJogador/${idJogador}&${type}&${pagina}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    /* console.log('Scores: ', json); */
                    console.log(json)
                    if (json.qtdPaginas == 0) {
                        Swal.fire({
                            imageUrl: './assets/img/gura-error.gif',
                            imageHeight: 150,
                            text: 'Esse jogador não possui nenhum score.',
                            showConfirmButton: false,
                            showDenyButton: true,
                            denyButtonText: 'OK'
                        });
                        return
                    }
                    console.log('Scores do jogador obtidos.');
                    loadPages(json.qtdPaginas, pagina, idJogador, type);

                    let element = document.getElementById('scores-player-list');
                    for (let i = 0; i < json.scores.length; i++) {
                        if (i == 6) break;
                        setScores(json.scores[i], element)
                    }
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao obter os scores do jogador!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })
    }

    function subDate(date, days) {
        var result = new Date(date);
        result.setDate(result.getDate() - days);
        return result.toISOString().substring(0, 10);
    }

    function setScores(score, element) {
        let liElement = document.createElement('li');
        liElement.onclick = () => { goToMapaPage(score.idMapa, score.nomeDificuldade) };

        let metric = getMetrics(score.precisao);
        if (metric == 'SSS') metric = 'perfect';

        /* <span>Há x Dias</span> */
        liElement.innerHTML = `<div class="player-score-info-container">
                                    <img src="/mapa/getImage/${score.hashMapa}">
                                    <div class="player-score-info">
                                        <div class="player-score-info-mapa-name">
                                            <div>
                                                <span class="title-ranking" style="font-size: 16px;">${score.nomeMusica}</span>
                                                <span>por ${score.artistaMusica}</span>  
                                            </div>
                                            <div>
                                                <span>mapeado por ${score.criadorMapa}</span>
                                                
                                            </div>
                                        </div>
                                        <div class="player-score-info-score-info">
                                            <span style="color: var(--${metric.toLocaleLowerCase()})">${score.precisao}%</span>
                                        </div>
                                        <div class="player-score-info-score-info ${score.nomeDificuldade.toLowerCase()}">
                                            <span>${score.pontosDePerformace}</span>
                                            <span style="color: #5e6bea">pp</span>
                                        </div>
                                    </div>
                                </div>`;
        element.appendChild(liElement);
    }

    function getMetrics(acc) {
        let accNum = parseFloat(acc);
        if (accNum >= 100) return 'SSS';
        else if (accNum >= 90) return 'SS';
        else if (accNum >= 80) return 'S';
        else if (accNum >= 65) return 'A';
        else if (accNum >= 50) return 'B';
        else if (accNum >= 35) return 'C';
        else if (accNum >= 20) return 'D';
        else if (accNum >= 0) return 'E';
    }

    function loadPages(totalPaginas, pagina, idJogador, type) {

        let pagesElement = document.getElementsByClassName('pages');


        createAntButton(pagesElement[0], totalPaginas, idJogador, pagina, type);

        printFirstPage(totalPaginas, pagesElement[0], idJogador, pagina, type);

        for (let i = pagina - 1; i < pagina + 2; i++) {
            if (i >= totalPaginas) break;

            if (i > 1) {
                printPage(i, totalPaginas, pagesElement[0], idJogador, pagina, type);
            }
            if (i == pagina + 1 && i + -1 != parseInt((totalPaginas / 2).toFixed(0))) printPage('...', totalPaginas, pagesElement[0], idJogador, pagina, type);
        }

        if (totalPaginas > 1) printLastPage(totalPaginas, pagesElement[0], idJogador, pagina, type);
        createNextButton(pagesElement[0], totalPaginas, idJogador, pagina, type);
    }

    function printFirstPage(totalPaginas, pagesElement, idJogador, pagina, type) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");

        if (pagina == 1) {
            pageElement.classList.add('selected');
            pageElement.style.cursor = 'default';
            pageElement.style.opacity = '0.5';
        } else {
            pageElement.onclick = () => { reloadPage(1, totalPaginas, idJogador, pagina, type) };
        }
        pageElement.innerHTML += 1;
        pageElement.id = `page-#${1}`;
        pagesElement.appendChild(pageElement);
    }

    function printPage(num, totalPaginas, pagesElement, idJogador, pagina, type) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");
        if (num != '...') {
            if (pagina == num) {
                pageElement.classList.add('selected');
                pageElement.style.cursor = 'default';
                pageElement.style.opacity = '0.5';
            } else {
                pageElement.onclick = () => { reloadPage(num, totalPaginas, idJogador, pagina, type) };
            }
            pageElement.innerHTML += num;
            pageElement.id = `page-#${num}`;
        } else {
            pageElement.innerHTML = num;
            pageElement.style.cursor = 'default';
        }


        pagesElement.appendChild(pageElement);
    }

    function printLastPage(totalPaginas, pagesElement, idJogador, pagina, type) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");

        if (pagina == totalPaginas) {
            pageElement.classList.add('selected');
            pageElement.style.cursor = 'default';
            pageElement.style.opacity = '0.5';
        } else {
            pageElement.onclick = () => { reloadPage(totalPaginas, totalPaginas, idJogador, pagina, type) };
        }
        pageElement.innerHTML += totalPaginas;
        pageElement.id = `page-#${totalPaginas}`;
        pagesElement.appendChild(pageElement);
    }

    function createAntButton(element, totalPaginas, idJogador, pagina, type) {
        let antPage = document.createElement('li');
        antPage.innerHTML = '<span>Ant</span>';
        if (pagina == 1 || totalPaginas == 0) {
            antPage.style.opacity = '0.5';
            antPage.style.cursor = 'default';
        } else {
            antPage.onclick = () => { reloadPage(false, totalPaginas, idJogador, pagina, type) };
        }
        element.appendChild(antPage);
    }

    function createNextButton(element, totalPaginas, idJogador, pagina, type) {
        let proxPage = document.createElement('li');
        proxPage.innerHTML = '<span>Próx</span>';
        if (pagina == totalPaginas || totalPaginas == 0) {
            proxPage.style.opacity = '0.5';
            proxPage.style.cursor = 'default';
        } else {
            proxPage.onclick = () => { reloadPage(true, totalPaginas, idJogador, pagina, type) };
        }
        element.appendChild(proxPage);
    }

    function reloadPage(nextPage, totalPaginas, idJogador, pagina, type) {
        if (!isNaN(parseInt(nextPage))) {
            pagina = parseInt(nextPage);
        } else {
            if (nextPage) {
                if (pagina == totalPaginas && pagina >= 1) return;
                pagina += 1;
            } else {
                if (pagina <= 1) return;
                pagina -= 1;
            }
        }

        let elementScore = document.getElementById('scores-player-list');

        elementScore.innerHTML = '';

        document.getElementsByClassName('pages')[0].innerHTML = '';
        getPlayerScores(idJogador, pagina);
        /* window.focus(); */
    }

    function goToMapaPage(idMapa, diff) {
        window.location.href = `./mapa.html?idmapa=${idMapa}&diff=${diff}`;
        window.focus();
    }

    function changeScores(element, idJogador, pagina) {
        document.getElementsByClassName('selected')[0].classList.remove('selected');
        element.classList.add('selected');

        document.getElementById('scores-player-list').innerHTML = '';

        document.getElementsByClassName('pages')[0].innerHTML = '';

        getPlayerScores(idJogador, pagina);
    }

    function editImage(type) {
        if (type == 'background') document.getElementById('arquivo-background').click();
        else document.getElementById('arquivo-perfil').click();
    }
    /* Favoritos */

    function loadPagesFavoritos(totalPaginas, idJogador) {

        let pagesElement = document.getElementsByClassName('pages');

        createAntButtonFavorite(pagesElement[1], totalPaginas, idJogador);

        printFirstPageFavorite(totalPaginas, pagesElement[1], idJogador);

        for (let i = paginaFavorito - 1; i < paginaFavorito + 2; i++) {
            if (i >= totalPaginas) break;

            if (i > 1) {
                printPageFavorite(i, totalPaginas, pagesElement[1], idJogador);
            }
            if (i == paginaFavorito + 1 && i + -1 != parseInt((totalPaginas / 2).toFixed(0))) printPageFavorite('...', totalPaginas, pagesElement[1], idJogador);
        }

        if (totalPaginas > 1) printLastPageFavorite(totalPaginas, pagesElement[1], idJogador);
        createNextButtonFavorite(pagesElement[1], totalPaginas, idJogador);

    }

    function printFirstPageFavorite(totalPaginas, pagesElement, idJogador) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");

        if (paginaFavorito == 1) {
            pageElement.classList.add('selected');
            pageElement.style.cursor = 'default';
            pageElement.style.opacity = '0.5';
        } else {
            pageElement.onclick = () => { reloadPageFavorite(1, totalPaginas, idJogador) };
        }
        pageElement.innerHTML += 1;
        pageElement.id = `page-#${1}`;
        pagesElement.appendChild(pageElement);
    }

    function printPageFavorite(num, totalPaginas, pagesElement, idJogador) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");
        if (num != '...') {
            if (paginaFavorito == num) {
                pageElement.classList.add('selected');
                pageElement.style.cursor = 'default';
                pageElement.style.opacity = '0.5';
            } else {
                pageElement.onclick = () => { reloadPageFavorite(num, totalPaginas, idJogador) };
            }
            pageElement.innerHTML += num;
            pageElement.id = `page-#${num}`;
        } else {
            pageElement.innerHTML = num;
            pageElement.style.cursor = 'default';
        }


        pagesElement.appendChild(pageElement);
    }

    function printLastPageFavorite(totalPaginas, pagesElement, idJogador) {
        let pageElement = document.createElement('li');
        pageElement.classList.add("page-num");

        if (paginaFavorito == totalPaginas) {
            pageElement.classList.add('selected');
            pageElement.style.cursor = 'default';
            pageElement.style.opacity = '0.5';
        } else {
            pageElement.onclick = () => { reloadPageFavorite(totalPaginas, totalPaginas, idJogador) };
        }
        pageElement.innerHTML += totalPaginas;
        pageElement.id = `page-#${totalPaginas}`;
        pagesElement.appendChild(pageElement);
    }

    function createAntButtonFavorite(element, totalPaginas, idJogador) {
        let antPage = document.createElement('li');
        antPage.innerHTML = '<span>Ant</span>';
        if (paginaFavorito == 1 || totalPaginas == 0) {
            antPage.style.opacity = '0.5';
            antPage.style.cursor = 'default';
        } else {
            antPage.onclick = () => { reloadPageFavorite(false, totalPaginas, idJogador) };
        }
        element.appendChild(antPage);
    }

    function createNextButtonFavorite(element, totalPaginas, idJogador) {
        let proxPage = document.createElement('li');
        proxPage.innerHTML = '<span>Próx</span>';
        if (paginaFavorito == totalPaginas || totalPaginas == 0) {
            proxPage.style.opacity = '0.5';
            proxPage.style.cursor = 'default';
        } else {
            proxPage.onclick = () => { reloadPageFavorite(true, totalPaginas, idJogador) };
        }
        element.appendChild(proxPage);
    }

    function reloadPageFavorite(nextPage, totalPaginas, idJogador) {
        if (!isNaN(parseInt(nextPage))) {
            paginaFavorito = parseInt(nextPage);
        } else {
            if (nextPage) {
                if (paginaFavorito == totalPaginas && paginaFavorito >= 1) return;
                paginaFavorito += 1;
            } else {
                if (paginaFavorito <= 1) return;
                paginaFavorito -= 1;
            }
        }

        let elementScore = document.getElementById('scores-favorite-player-list');

        elementScore.innerHTML = '';

        document.getElementsByClassName('pages')[1].innerHTML = '';
        getPlayerScoresFavorite(idJogador);
        /* window.focus(); */
    }

    function getPlayerScoresFavorite(idJogador) {

        fetch(`/score/listarScoresFavoritosJogador/${idJogador}&${paginaFavorito}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log('Resposta: ', response);

            if (response.ok) {
                response.json().then(json => {
                    /* console.log('Scores: ', json); */
                    if (json.qtdPaginas == 0) {
                        Swal.fire({
                            imageUrl: './assets/img/gura-error.gif',
                            imageHeight: 150,
                            text: 'Esse jogador não possui nenhum score favorito.',
                            showConfirmButton: false,
                            showDenyButton: true,
                            denyButtonText: 'OK'
                        });
                        return
                    }
                    console.log('Scores favoritos do jogador obtidos.')
                    loadPagesFavoritos(json.qtdPaginas, idJogador);

                    let element = document.getElementById('scores-favorite-player-list');
                    for (let i = 0; i < json.scores.length; i++) {
                        if (i == 6) break;
                        setScores(json.scores[i], element)
                    }
                });

            } else {
                Swal.fire({
                    title: 'Erro',
                    text: 'Houve um erro ao obter os scores do jogador!',
                    icon: 'error',
                    showConfirmButton: false,
                    showDenyButton: true,
                    denyButtonText: 'OK',
                });
                throw ('Houve um erro ao carregar o perfil!');
            }
        }).catch(function (response) {
            console.log(`ERRO: ${response}`);
        })
    }

    /* Editar Nick */

    function editName() {
        let newNick;
        Swal.fire({
            title: 'Digite o seu novo username',
            input: 'text',
            inputAttributes: {
                autocapitalize: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Atualizar',
            showLoaderOnConfirm: true,
            preConfirm: (nick) => {
                return fetch(`/jogador/editarNick/${sessionStorage.IDJOGADOR}&${nick}`, {
                    method: "GET"
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText)
                        }
                        newNick = nick;
                        return response.json()
                    })
                    .catch(error => {
                        Swal.showValidationMessage(
                            `Erro ao editar o username: ${error}`
                        )
                    })
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('player-name').innerHTML = newNick.trim();
                document.getElementById('username').innerHTML = newNick.trim();
                Swal.fire({
                    title: `Username Atualizado`,
                })
            }
        })
    }
</script>


</html>